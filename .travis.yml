sudo: required
# Trusty distribution is much faster when sudo is required
dist: trusty

language: go
go:
  - 1.9

go_import_path: github.com/coredns/coredns

git:
  depth: 3

env:
  #- TEST_TYPE=coverage
  #- TEST_TYPE=integration ETCD_VERSION=2.3.1
  - TEST_TYPE=integration-k8s1 K8S_EMULATOR=minikube K8S_VERSION=v1.7.5
  #- TEST_TYPE=integration-k8s2 K8S_EMULATOR=minikube K8S_VERSION=v1.7.5
  #- TEST_TYPE=integration-k8sexclust K8S_EMULATOR=hyperkube K8S_VERSION=v1.5.0
  #- TEST_TYPE=core
  #- TEST_TYPE=plugin

# In the Travis VM-based build environment, IPv6 networking is not
# enabled by default. The sysctl operations below enable IPv6.
# IPv6 is needed by some of the CoreDNS test cases. The VM environment
# is needed to have access to sudo in the test environment. Sudo is
# needed to have docker in the test environment.
# (Dependencies are fun! :) )
before_install:
  - cat /proc/net/if_inet6
  - uname -a
  - sudo bash -c 'if [ `cat /proc/net/if_inet6 | wc -l` = "0" ]; then echo "Enabling IPv6" ; sysctl net.ipv6.conf.all.disable_ipv6=0 ; sysctl net.ipv6.conf.default.disable_ipv6=0 ; sysctl net.ipv6.conf.lo.disable_ipv6=0 ; fi'
  - cat /proc/net/if_inet6
  - env

before_script:
  # Quickly check for code validity before setting up integration test environment
  - make check
  # Start etcd if version is set
  - if [ ! -z "$ETCD_VERSION" ]; then docker run -d --net=host --name=etcd quay.io/coreos/etcd:v$ETCD_VERSION; fi
  # Set up kubernetes
  - if [ "$K8S_EMULATOR" == "minikube" ]; then ./.travis/kubernetes/minikube_setup.sh; fi
  - if [ "$K8S_EMULATOR" == "hyperkube" ]; then ./.travis/kubernetes/hyperkube_setup.sh; fi

script:
  - make TEST_TYPE=$TEST_TYPE travis


after_success:
  - bash <(curl -s https://codecov.io/bash)
